# Парсер заведений с Яндекс.Карт

Здесь парсер, который собирает данные о заведениях (например, кафе) с Яндекс.Карт, включая информацию о самих заведениях (название, адрес, рейтинг, сайт, ) и их отзывах (текст отзыва, дата). Собранные данные сохраняются в базу данных PostgreSQL для дальнейшего анализа.

## Особенности

- **Парсинг динамического контента:** Использование Selenium с ChromeDriver для работы с динамически загружаемыми страницами.
- **Обработка капчи:** Автоматическое обнаружение и решение капчи на страницах Яндекс.Карт.
- **Хранение данных:** Сохранение информации о заведениях и отзывах в базе данных PostgreSQL.
- **Гибкая конфигурация:** Настройка через переменные окружения (тип заведения, URL поиска, включение/выключение парсера).
- **Контейнеризация:** Поддержка Docker и Docker Compose для упрощения развертывания и управления зависимостями.

## Требования

Для работы с проектом вам понадобятся:

- **Docker:** Установленный на вашей системе (см. официальную документацию).
- **Docker Compose:** Обычно устанавливается вместе с Docker (см. инструкцию).
- **Интернет-соединение:** Для загрузки зависимостей и доступа к Яндекс.Картам.

## Установка

1. Клонируйте репозиторий:
    ```bash
    git clone https://github.com/SUKUNA-AI/VenueInsightAI.git
    cd yandex_reviews_parser
    ```

2. Убедитесь, что файлы проекта присутствуют:
    - `Dockerfile` — для сборки образа приложения.
    - `requirements.txt` — зависимости Python.
    - `main.py` — основной скрипт парсера.
    - `docker-compose.yml` — конфигурация сервисов.

# Конфигурация проекта

Проект можно настроить как через файл `docker-compose.yml`, так и через флаги командной строки.

## Настройка через файл `docker-compose.yml`

Настройте проект через переменные окружения в файле `docker-compose.yml`. Откройте файл и измените следующие параметры в секции `environment` сервиса `app`:

- **`ENABLE_PARSER`**:
  - `true` — включает парсер.
  - `false` — выключает парсер (по умолчанию).
  
- **`TITLE`**:
  - Тип заведения для поиска (например, кафе, рестораны, бары). По умолчанию: кафе.

- **`BASE_URL`**:
  - Базовый URL для поиска на Яндекс.Картах (например, https://yandex.ru/maps/213/moscow/search/кафе). Убедитесь, что URL соответствует региону и типу заведения. По умолчанию: https://yandex.ru/maps/213/moscow/search/кафе.

### Пример настройки в `docker-compose.yml`:

```yaml
environment:
  - ENABLE_PARSER=true
  - TITLE=рестораны
  - BASE_URL=https://yandex.ru/maps/213/moscow/search/рестораны
```

### Настройка базы данных (опционально):

Вы также можете настроить параметры базы данных в секции `db`:

- **`POSTGRES_USER=postgres`**
- **`POSTGRES_PASSWORD=qwerty12345`**
- **`POSTGRES_DB=reviews_db`**

Эти значения по умолчанию обычно подходят для локального использования.

## Настройка через флаги командной строки

Вы можете передать параметры конфигурации через флаги командной строки при запуске контейнера с помощью команды `docker-compose run`. Используйте флаг `-e` для задания переменных окружения:

```bash
docker-compose run --rm -e ENABLE_PARSER=true -e TITLE=рестораны -e BASE_URL=https://yandex.ru/maps/213/moscow/search/рестораны app
```

### Параметры:

- **`-e ENABLE_PARSER=true`** — включает парсер.
- **`-e TITLE=рестораны`** — задает тип заведения.
- **`-e BASE_URL=https://yandex.ru/maps/213/moscow/search/рестораны`** — задает URL для поиска.

Эти параметры переопределят значения, указанные в файле `docker-compose.yml`.

## Параметры базы данных:

Дополнительно, можно настроить параметры базы данных в секции `db`:

- **`POSTGRES_USER=postgres`**
- **`POSTGRES_PASSWORD=qwerty12345`**
- **`POSTGRES_DB=reviews_db`**

Эти значения по умолчанию обычно подходят для локального использования.

## Запуск

1. Соберите и запустите контейнеры:
    ```bash
    docker-compose up --build
    ```
    Флаг `--build` пересобирает образы, если были внесены изменения в код или зависимости.

2. После запуска контейнер `app` начнёт работу, если `ENABLE_PARSER=true`.

## Проверка логов

Логи выводятся в терминал. Вы увидите сообщения о настройке базы данных, загрузке страниц и сборе данных. Для остановки используйте `Ctrl+C`.

## Использование

### Автоматический сбор данных

Парсер автоматически собирает ссылки на заведения с указанной страницы поиска (до 5000 ссылок или 30 минут прокрутки), затем обрабатывает каждую страницу заведения, извлекая данные и отзывы (до 200 отзывов на заведение). Данные сохраняются в таблицы `establishment_data` (заведения) и `reviews` (отзывы) в базе PostgreSQL.

### Доступ к базе данных

Подключитесь к базе данных через порт 5001 на хосте `localhost`:
- Используйте pgAdmin, DBeaver или команду:
    ```bash
    psql -h localhost -p 5001 -U postgres -d reviews_db
    ```
- Пароль: `qwerty12345`.

#### Таблицы:
- **establishment_data:** `id`, `href`, `name`, `address`, `phone`, `rate`, `rate_count`, `site`, `average_bill`.
- **reviews:** `id`, `establishment_id`, `author`, `rating`, `review_text`, `date`.

### Пример запроса к базе:
```sql
SELECT e.name, e.address, r.author, r.rating, r.review_text
FROM establishment_data e
JOIN reviews r ON e.id = r.establishment_id
WHERE e.name LIKE '%Кафе%';
```

## Примечания

### Ограничения Яндекса:
Частые запросы могут привести к временной блокировке со стороны Яндекс.Карт. Используйте парсер с осторожностью и избегайте чрезмерной нагрузки. Рекомендуется использовать VPN для смены IP-адреса при блокировках.

### Отладка:
При ошибках парсер сохраняет скриншоты (`captcha_error_*.png`) и HTML-страницы (`captcha_page_*.html`) для анализа проблем с капчей. Необработанные ссылки записываются в `failed_urls.txt`.

### Производительность:
Для ускорения обработки используется многопоточность (`ThreadPoolExecutor` с 5 потоками). При необходимости измените параметр `max_workers` в `main.py`.
